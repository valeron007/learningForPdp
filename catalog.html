<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet"  href="css/catalog.css" />

<!--    <script src="js/main.js"></script>-->
    <script>
        function loadScript(src) {
            return new Promise(function(resolve, reject) {
                let script = document.createElement('script');
                script.src = src;

                script.onload = () => resolve(script);
                script.onerror = () => reject(new Error(`Ошибка загрузки скрипта ${src}`));

                document.head.append(script);
            });
        }
        // function loadScript(src, callback) {
        //     let script = document.createElement('script');
        //     script.src = src;
        //
        //     script.onload = () => callback(null, script);
        //     script.onerror = () => callback(new Error(`Не удалось загрузить скрипт ${src}`));
        //
        //     document.head.append(script);
        // }
        /*
        loadScript('js/main.js', function() {
            newFunction();
        });
        */
        //loadScript("js/main.js");
        /*
        loadScript('js/main.js', function(error, script) {
            if (error) {
                console.log(script);
                console.log('error');
            } else {
                console.log(script);
                console.log('success');
            }
        });
        */
        //промисы
        /*
        let promise = new Promise(function(resolve, reject) {
            setTimeout(() => resolve("done"), 1000);
            //setTimeout(() => reject(new Error("Whoops!")), 1000);
        });

        promise.then(
            function(result) {
                console.log(result);
            },
            function(error) {
                console.log(error);
            }
        );
        */
        //подключение скриптов через промисы
        let promise = loadScript("https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.11/lodash.js");

        promise.then(
            script => console.log(`${script.src} загружен!`),
            error => console.log(`Ошибка: ${error.message}`)
        );

        promise.then(script => console.log('Ещё один обработчик...'));
        let loadFile = loadScript("js/main.js");
        loadFile.then(
            script => console.log(`${script.src} загружен!`),
            error => console.log(`Ошибка: ${error.message}`)
        )
        //получение рубрик
        /*
        let url = "https://www.klerk.ru/yindex.php/v3/event/rubrics?allowEmpty=1";
        fetch(url).then((response) => {
            return response.json()
        }).then((response) => {
            console.log(response);
        })

         */
        //получение пользователя
        /*
        fetch('/json/user.json')
            .then(response => response.json())
            .then(user => console.log(user.name));

        fetch('/json/user.json')
            // Загружаем данные в формате json
            .then(response => response.json())
            // Делаем запрос к GitHub
            .then(user => fetch(`https://api.github.com/users/${user.name}`))
            // Загружаем ответ в формате json
            .then(response => response.json())
            // Показываем аватар (githubUser.avatar_url) в течение 3 секунд (возможно, с анимацией)
            .then(githubUser => {
                console.log(githubUser);
                let img = document.createElement('img');
                img.src = githubUser.avatar_url;
                img.className = "promise-avatar-example";
                img.width = '100';
                img.height = '100';
                document.body.append(img);

                //setTimeout(() => img.remove(), 3000); // (*)
            });
        */
        function loadJson(url) {
            return fetch(url)
                .then(response => response.json());
        }

        function loadGithubUser(name) {
            return fetch(`https://api.github.com/users/${name}`)
                .then(response => response.json());
        }

        function showAvatar(githubUser) {
            return new Promise(function(resolve, reject) {
                let img = document.createElement('img');
                img.src = githubUser.avatar_url;
                img.className = "promise-avatar-example";
                document.body.append(img);

                setTimeout(() => {
                    img.remove();
                    resolve(githubUser);
                }, 3000);
            });
        }

        // Используем их:
        loadJson('/article/promise-chaining/user.json')
            .then(user => loadGithubUser(user.name))
            .then(showAvatar)
            .then(githubUser => alert(`Показ аватара ${githubUser.name} завершён`));

        //get commits
        async function getCommit() {
            let url = 'https://api.github.com/repos/javascript-tutorial/en.javascript.info/commits';
            let response = await fetch(url);

            let commits = await response.json(); // читаем ответ в формате JSON
            console.log(commits);
        }

        async function getImage() {
            let response = await fetch('/images/klerk.png');
            let blob = await response.blob(); // скачиваем как Blob-объект

            let img = document.createElement('img');
            img.style = 'position:fixed;top:10px;left:10px;width:100px';
            document.body.append(img);

            img.src = URL.createObjectURL(blob);
        }

        getCommit();
        getImage();

    </script>
</head>
<body>
    <div class="catalog">

    </div>
</body>
</html>